---
title: "Dranchuk-Purvis-Robinson"
output:
  html_document: default
  html_notebook: default
---

```{r setup, include=F, error=T, message=F, warning=F}
knitr::opts_chunk$set(echo=T, comment=NA, error=T, warning=F, message = F, fig.align = 'center')
```

The correlation was put in comptational form using two sources: the book "Equations of State and PVT Analysis" by Tarek Ahmed and the paper "New explicit correlation for the compressibility factor of natural gas" by Kareem, Iwalewa and Al-Marhoun.

We found an error in the constants in one of the sources and use the other one to reconstruct the right equation. Errors are found by comparing the results against the original data points in the Standing-Katz chart (1500 points). Usually errors are evident because the equation will not converge, give infinite values or results are just way off the real z values.

![](./images/DPR_error_constants_tarek_ahmed.jpg)

```{r}
# Dranchuk, Purvis, and Robinson (1974) developed a correlation based on the 
# Benedict-Webb-Rubin type of equation of state. Fitting the equation to 1500 
# data points from the Standing and Katz Z-factor chart optimized the eight 
# coefficients of the proposed equations. From Traker Ahmed's book.

pres.pr <- 6.5
temp.pr <- 1.3
tolerance = 1E-13
verbose <- TRUE

A1 <- 0.31506237  
A2 <- -1.0467099  
A3 <- -0.57832720 
A4 <-  0.53530771
A5 <- -0.61232032
A6 <- -0.10488813
A7 <- 0.68157001
A8 <- 0.68446549

T1 <- A1 + A2 / temp.pr + A3 / temp.pr^3
T2 <- A4 + A5 / temp.pr
T3 <- A5 * A6 / temp.pr
T4 <- A7 / temp.pr^3
T5 <- 0.27 * pres.pr / temp.pr

F <- function(rhor) {
    1 + T1 * rhor + T2 * rhor^2 + T3 * rhor^5 + 
        (T4 * rhor^2 * (1 + A8 * rhor^2) * exp(-A8 * rhor^2)) - T5 / rhor
}

Fprime <- function(rhor) {
    T1 + 2 * T2 * rhor + 5 * T3 * rhor^4 + 
        2 * T4 * rhor * exp(-A8 * rhor^2) * 
        ((1 + 2 * A8 * rhor^2) - A8 * rhor^2 * (1 + A8 * rhor^2)) +
         T5 / rhor^2
}


rhork0 <- 0.27 * pres.pr / temp.pr
rhork <- rhork0
i <- 1
while (TRUE) {
    if (abs(F(rhork)) < tolerance)  break    
    rhork1 <- rhork - F(rhork) / Fprime(rhork)
    delta <- abs(rhork - rhork1)
    if (delta < tolerance) break
    if (verbose) 
        cat(sprintf("%3d %11f %11f %11f \n", i, rhork, rhork1, delta))
    rhork <- rhork1
    i <- i + 1
}
z <- 0.27 * pres.pr / (rhork * temp.pr)
z

```

0.92
0.75
0.64
0.63
0.69
0.765
0.85





    (0.5, 1.3) = 0.92
    (1.5, 1.3) = 0.76
    (2.5, 1.3) = 0.64
    (3.5, 1.3) = 0.63
    (4.5, 1.3) = 0.68
    (5.5, 1.3) = 0.76
    (6.5, 1.3) = 0.84