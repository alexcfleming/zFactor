---
title: "Dranchuk-AbouKassem correlation"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Dranchuk-AbouKassem}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=F, error=T, message=F, warning=F}
knitr::opts_chunk$set(echo=T, comment=NA, error=T, warning=F, message = F, fig.align = 'center')
```


## How do we find the limits of accuracy in the `DAK` correlation


## Get `z` at selected `Ppr` and `Tpr`

```{r}
# get a z value using HY
library(zFactor)

z.DranchukAbuKassem(pres.pr = 1.5, temp.pr = 2.0)
# HY = 0.9580002
```

From the Standing-Katz chart we obtain a digitized point at the same `Ppr` and `Tpr`:

```{r}
# get a z value from the SK chart at the same Ppr and Tpr
library(zFactor)

tpr_vec <- c(2.0)
getStandingKatzMatrix(tpr_vector = tpr_vec, 
                      pprRange = "lp")[1, "1.5"]
```

It looks pretty good.


## Get `z` at selected `Ppr` and `Tpr`

```{r}
library(zFactor)

z.DranchukAbuKassem(pres.pr = 1.5, temp.pr = 1.1)
```

From the `Standing-Katz` chart we obtain a digitized point:

```{r}
library(zFactor)

tpr_vec <- c(1.1)
getStandingKatzMatrix(tpr_vector = tpr_vec, 
                      pprRange = "lp")[1, "1.5"]
```

At lower `Tpr` we can see that there is some error.


> We perceive a  difference between the values of z from the DAK calculation and the value read from the Standing-Katz chart.


## Get values of `z` for several `Ppr` and `Tpr`

```{r}
# test HY with 1st-derivative using the values from paper 
 
ppr <- c(0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5) 
tpr <- c(1.3, 1.5, 1.7, 2) 
 
dak <- sapply(ppr, function(x)  
    sapply(tpr, function(y) z.DranchukAbuKassem(pres.pr = x, temp.pr = y))) 
 
rownames(dak) <- tpr 
colnames(dak) <- ppr 
print(dak)

# Hall-Yarborough
#    0.5       1.5       2.5       3.5       4.5       5.5       6.5
# 1.3 0.9176300 0.7534433 0.6399020 0.6323003 0.6881127 0.7651710 0.8493794
# 1.5 0.9496855 0.8581232 0.7924067 0.7687902 0.7868071 0.8316848 0.8906351
# 1.7 0.9682547 0.9134862 0.8756412 0.8605668 0.8694525 0.8978885 0.9396353
# 2   0.9838234 0.9580002 0.9426939 0.9396286 0.9490995 0.9697839 0.9994317
```


With the same `ppr` and `tpr` vectors, we do the same for the Standing-Katz chart:

```{r}
library(zFactor)

sk <- getStandingKatzMatrix(ppr_vector = ppr, tpr_vector = tpr)
sk
```

Subtract and find the difference:

```{r}
err <- round((sk - dak) / sk * 100, 2)
err
```

## Error by Ppr and by PPr

```{r}
print(colSums(err))
```

```{r}
print(rowSums(err))
```

## Analyze the error for smaller values of `Tpr`

```{r}
library(zFactor)

tpr2 <- c(1.05, 1.1) 
ppr2 <- c(0.5, 1.5, 2.5, 3.5, 4.5, 5.5) 


sk2 <- getStandingKatzMatrix(ppr_vector = ppr2, tpr_vector = tpr2, pprRange = "lp")
sk2
```


We do the same with the DAK correlation:

```{r}
# calculate z values at lower values of Tpr
library(zFactor)

dak2 <- sapply(ppr2, function(x)  
    sapply(tpr2, function(y) z.DranchukAbuKassem(pres.pr = x, temp.pr = y))) 
 
rownames(dak2) <- tpr2
colnames(dak2) <- ppr2
print(dak2)
```

```{r}
err2 <- round((sk2 - dak2) / sk2 * 100, 2)
err2
```

<!-- We can see that using Hall-Yarborough correlation shows a very high error at values of `Tpr` lower or equal than `1.1` being `Tpr=1.05` the worst curve to extract z values from. -->

```{r}
t_err2 <- t(err2)
t_err2
```


```{r}
sum_t_err2 <- summary(t_err2)
sum_t_err2
```

We can see that the errors in `z` with `DAK` are less than `HY` with a `r sum_t_err2[1,1]`% and `r sum_t_err2[6,1]`% for `Tpr=1.05`, and a `r sum_t_err2[1,2]`% and `r sum_t_err2[6,2]`% for `Tpr=1.10`. But there are still errors.


## Prepare to plot SK vs DAK correlation

```{r}
library(zFactor)

tpr2 <- c(1.05, 1.1, 1.2, 1.3) 
ppr2 <- c(0.5, 1.0, 1.5, 2, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 6.5) 

sk_dak_2 <- createTidyFromMatrix(ppr2, tpr2, correlation = "DAK")
sk_dak_2
```


```{r}
library(ggplot2)

p <- ggplot(sk_dak_2, aes(x=Ppr, y=z.calc, group=Tpr, color=Tpr)) +
    geom_line() +
    geom_point() +
    geom_errorbar(aes(ymin=z.calc-dif, ymax=z.calc+dif), width=.4,
                  position=position_dodge(0.05))
print(p)
```

We can see with Dranchuk-AbouKassem there are still errors or differences between the values in the Standing-Katz chart and the values obtained from the correlation but they are not so bad as in the HY correlation.

## Analysis at the lowest `Tpr`

```{r}
sk_dak_3 <- sk_dak_2[sk_dak_2$Tpr==1.05,]
sk_dak_3
```


```{r}
library(zFactor)

p <- ggplot(sk_dak_3, aes(x=Ppr, y=z.calc, group=Tpr, color=Tpr)) +
    geom_line() +
    geom_point() +
    geom_errorbar(aes(ymin=z.calc-dif, ymax=z.calc+dif), width=.2,
                  position=position_dodge(0.05))
print(p)
```

```{r}
summary(sk_dak_3)
```

